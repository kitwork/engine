package engine

import (
	"context"
	"fmt"
	"runtime"
	"sync"
	"time"

	"github.com/kitwork/engine/core"
)

// Test thá»±c thi script vá»›i sá»‘ vÃ²ng láº·p tÃ¹y chá»n (máº·c Ä‘á»‹nh lÃ  1) vÃ  bÃ¡o cÃ¡o hiá»‡u nÄƒng chi tiáº¿t (há»— trá»£ Ä‘a luá»“ng)
func Test(source string, iterations ...int) {
	iters := 1
	if len(iterations) > 0 {
		iters = iterations[0]
	}

	e := core.New()
	e.Config.Debug = false
	w, err := e.Build(source, "", "", "")
	if err != nil {
		fmt.Printf("âŒ Build Error: %v\n", err)
		return
	}

	// Cáº¥u hÃ¬nh worker count dá»±a trÃªn tÃ i nguyÃªn há»‡ thá»‘ng (GOMAXPROCS an toÃ n hÆ¡n NumCPU)
	workerCount := runtime.GOMAXPROCS(0)
	if iters < workerCount {
		workerCount = iters
	}

	// Chuáº©n bá»‹ Ä‘o lÆ°á»ng
	var msBefore, msAfter runtime.MemStats
	runtime.GC()
	runtime.ReadMemStats(&msBefore)
	start := time.Now()

	// Cháº¡y song song (Parallel execution)
	var wg sync.WaitGroup
	wg.Add(workerCount)
	itersPerWorker := iters / workerCount
	ctx := context.Background()

	for i := 0; i < workerCount; i++ {
		// Xá»­ lÃ½ ná»‘t cÃ¡c vÃ²ng láº·p dÆ° náº¿u iters khÃ´ng chia háº¿t cho workerCount
		count := itersPerWorker
		if i == workerCount-1 {
			count = iters - (itersPerWorker * (workerCount - 1))
		}

		go func(c int) {
			defer wg.Done()
			for j := 0; j < c; j++ {
				res := e.Trigger(ctx, w, nil, nil)
				if res.Error != "" {
					// Chá»‰ in lá»—i má»™t vÃ i láº§n Ä‘á»ƒ trÃ¡nh lÃ m cháº­m throughput do I/O log
					if j%1000 == 0 {
						fmt.Printf("âš ï¸ Lá»—i táº¡i worker: %v\n", res.Error)
					}
				}
			}
		}(count)
	}
	wg.Wait()

	duration := time.Since(start)
	runtime.ReadMemStats(&msAfter)

	// TÃ­nh toÃ¡n cÃ¡c chá»‰ sá»‘
	throughput := float64(iters) / duration.Seconds()
	if duration.Seconds() == 0 {
		throughput = 0
	}
	latency := duration / time.Duration(iters)
	totalAlloc := msAfter.TotalAlloc - msBefore.TotalAlloc
	gcCycles := msAfter.NumGC - msBefore.NumGC

	// In káº¿t quáº£ theo format yÃªu cáº§u
	fmt.Printf("\n"+
		"====================================================\n"+
		"          ğŸš€ ENGINE STRESS TEST (PARALLEL & POOLED)  \n"+
		"====================================================\n"+
		"       âš¡ PERFORMANCE METRICS\n"+
		"----------------------------------------------------\n"+
		"Total Iterations : %d\n"+
		"Total Duration   : %v\n"+
		"Throughput      : %.0f ops/sec\n"+
		"Avg Latency     : %v\n"+
		"\n"+
		"       âš™ï¸ SYSTEM & CONCURRENCY\n"+
		"----------------------------------------------------\n"+
		"Workers (Cores) : %d\n"+
		"\n"+
		"       ğŸ’¾ MEMORY & GC STATS\n"+
		"----------------------------------------------------\n"+
		"Alloc per Op    : %d bytes\n"+
		"Total Allocated : %.2f MB\n"+
		"GC Cycles       : %d\n"+
		"====================================================\n",
		iters, duration, throughput, latency,
		workerCount,
		totalAlloc/uint64(iters), float64(totalAlloc)/1024/1024,
		gcCycles)
}
